# Apple Push Notification Service
각 기기의 상태를 확인하여 상태에 따라 알림을 저장 후 보내주고 최신의 알림 상태를 관리하는 등의 관리센터 역할을 하는 서비스. 서버에서 기기로 알림을 보내지 않고 반드시 `APNs`를 거치게 해야한다.

APNs에는 저장 후에 전달기능을 수행하는 `QoS`구성 요소가 포함되어 있다. APNs가 알림 전달을 시도하고 알림을 전달받을 대상 장치가 오프라인인 경우에는 APNs는 제한된 시간동안 알림을 저장하고 장치가 사용 가능한 온라인 상태가 되면 알림을 전달하게 된다. APNs는 기기 및 앱별로 가장 최근의 알림만 저장한다. 따라서 장치가 오프라인인 경우에 해당 장치를 대상으로 하는 알림을 보내면 이전에 가지고 있던 요청은 삭제되고 최근의 알림만 저장하고 전달하게 된다. 각 프로바이더(각 앱 서비스의 서버)에서 보내는 각종 알림들을 최신 상태로 하나씩 저장하다가 장치가 장기간 오프라인 상태로 유지되면 저장된 모든 알림을 삭제한다.

알림의 탈취 및 내용 변조등의 보안 문제를 해결하기 위해 APNs는 자체 보안 아키텍쳐를 통해 원격 알림을 안전하게 제어한다. 두가지의 신뢰수준을 사용하는데 `connection trust`와 `device token trust` 두가지를 사용한다.

### connection trust(연결 신뢰)
Provider와 APNs간, APNs와 장치간의 작동을 하게된다.

#### Provider-to-APNs connection trust
공급자와 APNs간의 신뢰는 애플과 계약을 맺은 회사가 소유한 승인된 공급자만 APNs와 연결하여 푸시 알림 전달을 가능하게 하여 연결 신뢰를 구성한다. 공급자 서버는 APNs간의 연결 신뢰가 있는지 확인하는 단계를 수행해야 한다. 확인하는 두가지 방법은 `token-based`, `certificate-based`가 있다.
1. token-based: valid authentication key certificate. 유효한 인증키를 이용하여 확인
2. certificate-based: SSL certificate. ssl 인증서를 이용하여 확인

어떤 인증서 유형을 선택해도 원격 알림을 보내기 위해서는 Provider Connection trust가 APNs에 푸시 알림 요청을 보내는 전제조건이 되는 기본적인 trust가 된다. 해당 작업은 현업에서 푸시 알림 서버 구현을 하는 개발자가 담당하게 된다.

#### APNs-to-device connection trust
승인된 장치만 APNs에 연결하여 알림을 받을 수 있게 한다. APNs는 장치와 연결 신뢰를 자동으로 적용하여 안전을 보장한다

### device token trust
알림이 올바른 시작(제공자)과 끝(장치) 두가지 사이에서만 라우팅되게 한다. device token은 애플이 특정 장치의 특정 앱에 할당한 고유 식별자를 포함하는 `NSData`인스턴스이다. 이 토큰은 탈취하더라도 내용을 이해할 수 없고, 오직 APNs만 장치 토큰의 내용을 해독하고 읽을 수 있다. 따라서 각 앱은 원격 알림을 사용하기 위해서 APNs에 등록을 하게 되고 이때 고유한 장치 토큰을 받게 된다. 이 토큰은 해당 프로바이더에게 전달하고 프로바이더는 연결된 장치를 대상으로 하는 각각의 푸시 알림 요청에 장치 토큰을 포함하여 전달해야만 한다. APNs는 요청에 포함된 디바이스 토큰을 통해 푸시 알림이 고유한 디바이스 앱 조합에만 전달되도록 조정할 수 있다.<br>
APNs는 여러가지 상황에서 디바이스 토큰을 새로 발급 할 수 있다. 새 기기에 앱을 설치하거나, 백업으로 기기를 복원하거나, 운영체제를 다시 설치할 때 등 디바이스와 앱의 상태가 변경되었을 때 새로 발급하여 항상 고유한 상태를 바라보게 한다.